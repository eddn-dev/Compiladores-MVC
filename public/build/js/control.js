const AFNS=[];function handleModal(e){switch(e.getAttribute("id")){case"modal3":handleProbarAFD(e);break;case"modal8":handleCrearAFNBasico(e);break;case"modal9":handleUnirAFN(e);break;case"modal10":handleConcatenarAFN(e);break;case"modal11":handleAplicarCerraduraKleene(e);break;case"modal12":handleAplicarCerraduraPositiva(e);break;case"modal13":handleAplicarOpcional(e);break;case"modal14":handleObtenerAFD(e)}}function handleAFNModal(e,t){const a=e.querySelector("form"),n=a.querySelector(".modal_button.accept"),o=a.querySelector(".modal_button.cancel"),r={},l={};function c(){let e=!0;return t.fields.forEach((t=>{const a=l[t.name].value.trim(),n=r[t.name];if(n&&(n.textContent="",n.classList.remove("error")),t.validate){const o=t.validate(a,l);o&&(e=!1,n&&(n.textContent=o,n.classList.add("error")))}})),e}t.fields.forEach((e=>{l[e.name]=a.querySelector(e.selector),e.alertSelector&&(r[e.name]=a.querySelector(e.alertSelector))})),n.disabled=!0,t.populateAFNSelects&&actualizarSelectsDeAFN(l),a.addEventListener(t.validationEvent||"input",(()=>{const e=c();n.disabled=!e})),a.addEventListener("submit",(n=>{n.preventDefault();c()?(t.onSubmit(l,a),mostrarNotificacion("Operación realizada exitosamente.","success"),closeModal(e)):mostrarNotificacion("Por favor, corrige los errores antes de continuar.","error")})),o.addEventListener("click",(()=>{closeModal(e)}))}function handleCrearAFNBasico(e){handleAFNModal(e,{fields:[{name:"automatonId",selector:"#automaton-id",alertSelector:"#automaton-id-alert",validate:e=>e?/^[0-9]+$/.test(e)?AFNS.some((t=>t.ID_AFN===e))?"El ID ya existe. Elige otro.":null:"El ID solo puede contener números.":"El ID es obligatorio."},{name:"startSymbol",selector:"#start-symbol",alertSelector:"#start-symbol-alert",validate:e=>e?esCaracterValido(e)?null:"El símbolo de inicio debe ser un carácter válido.":"El símbolo de inicio es obligatorio."},{name:"endSymbol",selector:"#end-symbol",alertSelector:"#end-symbol-alert",validate:(e,t)=>{const a=t.startSymbol.value.trim();if(e){if(!esCaracterValido(e))return"El símbolo de final debe ser un carácter válido o estar vacío.";if(a&&a>e)return"El símbolo final no puede ser menor que el símbolo inicial (valor ASCII)."}return null}}],onSubmit:(e,t)=>{const a=e.automatonId.value.trim(),n=e.startSymbol.value.trim(),o=e.endSymbol.value.trim()||null;let r=AFN.Crear_Basico_AFN(n,o);r.ID_AFN=a;switch(t.querySelector('input[name="cerradura"]:checked').value){case"kleene":r.Cerradura_Kleene();break;case"epsilon":r.Cerradura_Positiva()}AFNS.push(r),actualizarSelectsDeAFN()},successMessage:"AFN básico creado exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleUnirAFN(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."},{name:"afnId2",selector:"#automaton-id-2",alertSelector:"#automaton-id-2-alert",validate:(e,t)=>{const a=t.afnId1.value.trim();return e?e===a?"Debes seleccionar un AFN diferente.":null:"Selecciona un AFN."}}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,t)=>{const a=e.afnId1.value,n=e.afnId2.value,o=AFNS.findIndex((e=>e.ID_AFN===a)),r=AFNS.findIndex((e=>e.ID_AFN===n)),l=AFNS[o],c=AFNS[r];l.Unir(c);switch(t.querySelector('input[name="cerradura"]:checked').value){case"kleene":l.Cerradura_Kleene();break;case"epsilon":l.Cerradura_Positiva()}AFNS.splice(r,1),actualizarSelectsDeAFN()},successMessage:"AFNs unidos exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleConcatenarAFN(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."},{name:"afnId2",selector:"#automaton-id-2",alertSelector:"#automaton-id-2-alert",validate:(e,t)=>{const a=t.afnId1.value.trim();return e?e===a?"Debes seleccionar un AFN diferente.":null:"Selecciona un AFN."}}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,t)=>{const a=e.afnId1.value,n=e.afnId2.value,o=AFNS.findIndex((e=>e.ID_AFN===a)),r=AFNS.findIndex((e=>e.ID_AFN===n)),l=AFNS[o],c=AFNS[r];l.Concatenar(c);switch(t.querySelector('input[name="cerradura"]:checked').value){case"kleene":l.Cerradura_Kleene();break;case"epsilon":l.Cerradura_Positiva()}AFNS.splice(r,1),actualizarSelectsDeAFN()},successMessage:"AFNs concatenados exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleAplicarCerraduraKleene(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,t)=>{const a=e.afnId1.value,n=AFNS.findIndex((e=>e.ID_AFN===a));AFNS[n].Cerradura_Kleene(),actualizarSelectsDeAFN()},successMessage:"Cerradura de Kleene aplicada exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleAplicarCerraduraPositiva(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,t)=>{const a=e.afnId1.value,n=AFNS.findIndex((e=>e.ID_AFN===a));AFNS[n].Cerradura_Positiva(),actualizarSelectsDeAFN()},successMessage:"Cerradura positiva aplicada exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleAplicarOpcional(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,t)=>{const a=e.afnId1.value,n=AFNS.findIndex((e=>e.ID_AFN===a));AFNS[n].Opcional(),actualizarSelectsDeAFN()},successMessage:"Operador opcional aplicado exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function esCaracterValido(e){if(1!==e.length)return!1;const t=e.charCodeAt(0);return t>=32&&t<=126}function closeModal(e){const t=new CustomEvent("closeModal",{detail:{modal:e}});document.dispatchEvent(t)}function actualizarSelectsDeAFN(e=null){if(e){for(const t in e)if("SELECT"===e[t].tagName){const a=e[t];a.innerHTML='<option value="">Sin selección</option>',AFNS.forEach((e=>{const t=document.createElement("option");t.value=e.ID_AFN,t.textContent=e.ID_AFN,a.appendChild(t)}))}}else{document.querySelectorAll('select[name^="automaton-id"]').forEach((e=>{e.innerHTML='<option value="">Sin selección</option>',AFNS.forEach((t=>{const a=document.createElement("option");a.value=t.ID_AFN,a.textContent=t.ID_AFN,e.appendChild(a)}))}))}}function handleObtenerAFD(e){const t=e.querySelector("#form-obtener-afd"),a=t.querySelector(".modal_button.accept"),n=t.querySelector(".modal_button.cancel"),o=t.querySelector("#tabla-afns"),r=t.querySelector("#tabla-afns-alert");function l(e,a,n){if(n.textContent="",a.classList.remove("input-error"),e.checked){const e=a.value.trim();if(/^[0-9]+$/.test(e)){const o=parseInt(e);Array.from(t.querySelectorAll('input[name^="token_afn_"]')).filter((e=>e!==a&&!e.disabled)).map((e=>parseInt(e.value.trim()))).filter((e=>!isNaN(e))).includes(o)&&(a.classList.add("input-error"),n.appendChild(i("El token ya está asignado a otro AFN.")))}else a.classList.add("input-error"),n.appendChild(i("El token debe ser un número entero."))}}function c(){t.querySelectorAll('input[name="unir_afn"]').forEach((e=>{const a=e.value;l(e,t.querySelector('input[name="token_afn_'+a+'"]'),e.parentElement.parentElement.nextSibling.firstChild)}))}function i(e){const t=document.createElement("small");return t.classList.add("error-message"),t.textContent=e,t}!function(){if(o.innerHTML="",0===AFNS.length){const e=document.createElement("tr"),t=document.createElement("td");return t.setAttribute("colspan","3"),t.textContent="No hay AFNs disponibles.",e.appendChild(t),o.appendChild(e),void(a.disabled=!0)}a.disabled=!1,AFNS.forEach((e=>{const t=document.createElement("tr"),a=document.createElement("td");a.textContent=e.ID_AFN,t.appendChild(a);const n=document.createElement("td"),r=document.createElement("input");r.type="checkbox",r.name="unir_afn",r.value=e.ID_AFN,n.appendChild(r),t.appendChild(n);const c=document.createElement("td"),i=document.createElement("input");i.type="text",i.name="token_afn_"+e.ID_AFN,i.size="5",i.disabled=!0,c.appendChild(i),t.appendChild(c);const s=document.createElement("tr"),d=document.createElement("td");d.setAttribute("colspan","3"),d.classList.add("error-cell"),s.appendChild(d),o.appendChild(t),o.appendChild(s),r.addEventListener("change",(function(){i.disabled=!this.checked,l(r,i,d)})),i.addEventListener("input",(function(){l(r,i,d)}))}))}(),t.addEventListener("input",(function(){c()})),t.addEventListener("submit",(function(a){a.preventDefault(),r.textContent="",r.classList.remove("error");let n=!0,o=[];c();const l=t.querySelectorAll('input[name="unir_afn"]:checked');if(0===l.length?(n=!1,r.textContent="Debe seleccionar al menos un AFN para unir.",r.classList.add("error")):l.forEach((e=>{const a=e.value,r=t.querySelector('input[name="token_afn_'+a+'"]'),l=r.value.trim();r.classList.contains("input-error")?n=!1:o.push({afn:AFNS.find((e=>e.ID_AFN===a)),token:parseInt(l)})})),n){o.forEach((e=>{e.afn.Edos_Acept.forEach((t=>{t.Token=e.token}))}));const t=o.map((e=>e.afn)),a=AFN.UnirAFNs(t);a.convertirAFD();const n=a.generarContenidoArchivo();iniciarDescarga(n,"matriz_transicion.txt"),mostrarNotificacion("Archivo generado exitosamente.","success"),closeModal(e)}else mostrarNotificacion("Por favor, corrige los errores antes de continuar.","error")})),n.addEventListener("click",(function(){closeModal(e)}))}function mostrarNotificacion(e,t="success"){const a=document.getElementById("notification-container"),n=document.createElement("div");n.classList.add("notification",t,"scale-in-center");const o=`\n      <h2>${"success"===t?"Éxito":"Error"}</h2>\n      <p>${e}</p>\n    `;n.innerHTML=o,a.appendChild(n),setTimeout((()=>{n.classList.remove("scale-in-center"),n.classList.add("scale-out-center"),n.addEventListener("animationend",(()=>{a.removeChild(n)}))}),2500)}function handleProbarAFD(e){const t=e.querySelector(".modal_content_dinamic"),a=e.querySelector(".modal_button.accept"),n=e.querySelector(".modal_button.cancel");let o=null;function r(){t.innerHTML="";const e=document.createElement("button");e.textContent="Cargar Archivo de AFD",e.classList.add("modal_button"),t.appendChild(e),e.addEventListener("click",(()=>{!function(){const e=document.createElement("input");e.type="file",e.accept=".txt",e.onchange=e=>{const a=e.target.files[0];if(!a)return;const n=new FileReader;n.onload=function(e){const a=e.target.result;try{const e=function(e){const t=e.split("\n").filter((e=>""!==e.trim())),a=[];for(let e=0;e<t.length;e++){const n=t[e].split(",");if(258!==n.length)throw new Error(`La línea ${e+1} no tiene 258 columnas.`);const o=n.map((e=>parseInt(e.trim())));if(o.some((e=>isNaN(e))))throw new Error(`Valores inválidos en la línea ${e+1}.`);a.push(o)}return a}(a);o=new AnalizadorLexico("",e),function(){t.innerHTML="";const e=document.createElement("button");e.textContent="Cambiar AFD",e.classList.add("modal_button");const a=document.createElement("input");a.type="text",a.placeholder="Ingrese la cadena a analizar",a.classList.add("input_text");const n=document.createElement("button");n.textContent="Probar AFD",n.classList.add("modal_button");const l=document.createElement("div");l.classList.add("resultados");const c=document.createElement("table");c.classList.add("tabla_resultados");const i=document.createElement("thead"),s=document.createElement("tr"),d=document.createElement("th");d.textContent="Lexema";const u=document.createElement("th");u.textContent="Token",s.appendChild(d),s.appendChild(u),i.appendChild(s),c.appendChild(i);const m=document.createElement("tbody");c.appendChild(m),l.appendChild(c),t.appendChild(e),t.appendChild(document.createElement("br")),t.appendChild(a),t.appendChild(n),t.appendChild(l),e.addEventListener("click",(()=>{o=null,r()})),n.addEventListener("click",(()=>{const e=a.value.trim();if(""===e)return void mostrarNotificacion("Ingrese una cadena para analizar.","error");let t;o.setSigma(e),m.innerHTML="";try{for(;(t=o.yylex())!==SimbolosEspeciales.FIN;){const e=o.getLexema(),a=document.createElement("tr"),n=document.createElement("td");n.textContent=e;const r=document.createElement("td");r.textContent=t,a.appendChild(n),a.appendChild(r),m.appendChild(a)}mostrarNotificacion("Análisis completado.","success")}catch(e){mostrarNotificacion("Error durante el análisis: "+e.message,"error")}}))}(),mostrarNotificacion("AFD cargado exitosamente.","success")}catch(e){mostrarNotificacion("Error al cargar el AFD: "+e.message,"error")}},n.onerror=function(e){mostrarNotificacion("Error al leer el archivo.","error")},n.readAsText(a)},e.click()}()}))}r(),a.addEventListener("click",(()=>{closeModal(e)})),n.addEventListener("click",(()=>{closeModal(e)}))}document.addEventListener("modalLoaded",(function(e){const t=e.detail.modal;handleModal(t),console.log("modal"+t.getAttribute("id"))}));