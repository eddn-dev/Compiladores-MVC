const AFNS=[];function handleModal(e){switch(e.getAttribute("id")){case"modal8":handleCrearAFNBasico(e);break;case"modal9":handleUnirAFN(e);break;case"modal10":handleConcatenarAFN(e);break;case"modal11":handleAplicarCerraduraKleene(e);break;case"modal12":handleAplicarCerraduraPositiva(e);break;case"modal13":handleAplicarOpcional(e);break;case"modal14":handleObtenerAFD(e)}}function handleAFNModal(e,a){const t=e.querySelector("form"),n=t.querySelector(".modal_button.accept"),o=t.querySelector(".modal_button.cancel"),r={},l={};function c(){let e=!0;return a.fields.forEach((a=>{const t=l[a.name].value.trim(),n=r[a.name];if(n&&(n.textContent="",n.classList.remove("error")),a.validate){const o=a.validate(t,l);o&&(e=!1,n&&(n.textContent=o,n.classList.add("error")))}})),e}a.fields.forEach((e=>{l[e.name]=t.querySelector(e.selector),e.alertSelector&&(r[e.name]=t.querySelector(e.alertSelector))})),n.disabled=!0,a.populateAFNSelects&&actualizarSelectsDeAFN(l),t.addEventListener(a.validationEvent||"input",(()=>{const e=c();n.disabled=!e})),t.addEventListener("submit",(n=>{n.preventDefault();c()?(a.onSubmit(l,t),mostrarNotificacion("Operación realizada exitosamente.","success"),closeModal(e)):mostrarNotificacion("Por favor, corrige los errores antes de continuar.","error")})),o.addEventListener("click",(()=>{closeModal(e)}))}function handleCrearAFNBasico(e){handleAFNModal(e,{fields:[{name:"automatonId",selector:"#automaton-id",alertSelector:"#automaton-id-alert",validate:e=>e?/^[0-9]+$/.test(e)?AFNS.some((a=>a.ID_AFN===e))?"El ID ya existe. Elige otro.":null:"El ID solo puede contener números.":"El ID es obligatorio."},{name:"startSymbol",selector:"#start-symbol",alertSelector:"#start-symbol-alert",validate:e=>e?esCaracterValido(e)?null:"El símbolo de inicio debe ser un carácter válido.":"El símbolo de inicio es obligatorio."},{name:"endSymbol",selector:"#end-symbol",alertSelector:"#end-symbol-alert",validate:(e,a)=>{const t=a.startSymbol.value.trim();if(e){if(!esCaracterValido(e))return"El símbolo de final debe ser un carácter válido o estar vacío.";if(t&&t>e)return"El símbolo final no puede ser menor que el símbolo inicial (valor ASCII)."}return null}}],onSubmit:(e,a)=>{const t=e.automatonId.value.trim(),n=e.startSymbol.value.trim(),o=e.endSymbol.value.trim()||null;let r=AFN.Crear_Basico_AFN(n,o);r.ID_AFN=t;switch(a.querySelector('input[name="cerradura"]:checked').value){case"kleene":r.Cerradura_Kleene();break;case"epsilon":r.Cerradura_Positiva()}AFNS.push(r),actualizarSelectsDeAFN()},successMessage:"AFN básico creado exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleUnirAFN(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."},{name:"afnId2",selector:"#automaton-id-2",alertSelector:"#automaton-id-2-alert",validate:(e,a)=>{const t=a.afnId1.value.trim();return e?e===t?"Debes seleccionar un AFN diferente.":null:"Selecciona un AFN."}}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,a)=>{const t=e.afnId1.value,n=e.afnId2.value,o=AFNS.findIndex((e=>e.ID_AFN===t)),r=AFNS.findIndex((e=>e.ID_AFN===n)),l=AFNS[o],c=AFNS[r];l.Unir(c);switch(a.querySelector('input[name="cerradura"]:checked').value){case"kleene":l.Cerradura_Kleene();break;case"epsilon":l.Cerradura_Positiva()}AFNS.splice(r,1),actualizarSelectsDeAFN()},successMessage:"AFNs unidos exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleConcatenarAFN(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."},{name:"afnId2",selector:"#automaton-id-2",alertSelector:"#automaton-id-2-alert",validate:(e,a)=>{const t=a.afnId1.value.trim();return e?e===t?"Debes seleccionar un AFN diferente.":null:"Selecciona un AFN."}}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,a)=>{const t=e.afnId1.value,n=e.afnId2.value,o=AFNS.findIndex((e=>e.ID_AFN===t)),r=AFNS.findIndex((e=>e.ID_AFN===n)),l=AFNS[o],c=AFNS[r];l.Concatenar(c);switch(a.querySelector('input[name="cerradura"]:checked').value){case"kleene":l.Cerradura_Kleene();break;case"epsilon":l.Cerradura_Positiva()}AFNS.splice(r,1),actualizarSelectsDeAFN()},successMessage:"AFNs concatenados exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleAplicarCerraduraKleene(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,a)=>{const t=e.afnId1.value,n=AFNS.findIndex((e=>e.ID_AFN===t));AFNS[n].Cerradura_Kleene(),actualizarSelectsDeAFN()},successMessage:"Cerradura de Kleene aplicada exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleAplicarCerraduraPositiva(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,a)=>{const t=e.afnId1.value,n=AFNS.findIndex((e=>e.ID_AFN===t));AFNS[n].Cerradura_Positiva(),actualizarSelectsDeAFN()},successMessage:"Cerradura positiva aplicada exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function handleAplicarOpcional(e){handleAFNModal(e,{fields:[{name:"afnId1",selector:"#automaton-id-1",alertSelector:"#automaton-id-1-alert",validate:e=>e?null:"Selecciona un AFN."}],validationEvent:"change",populateAFNSelects:!0,onSubmit:(e,a)=>{const t=e.afnId1.value,n=AFNS.findIndex((e=>e.ID_AFN===t));AFNS[n].Opcional(),actualizarSelectsDeAFN()},successMessage:"Operador opcional aplicado exitosamente.",errorMessage:"Por favor, corrige los errores antes de continuar."})}function esCaracterValido(e){if(1!==e.length)return!1;const a=e.charCodeAt(0);return a>=32&&a<=126}function closeModal(e){const a=new CustomEvent("closeModal",{detail:{modal:e}});document.dispatchEvent(a)}function actualizarSelectsDeAFN(e=null){if(e){for(const a in e)if("SELECT"===e[a].tagName){const t=e[a];t.innerHTML='<option value="">Sin selección</option>',AFNS.forEach((e=>{const a=document.createElement("option");a.value=e.ID_AFN,a.textContent=e.ID_AFN,t.appendChild(a)}))}}else{document.querySelectorAll('select[name^="automaton-id"]').forEach((e=>{e.innerHTML='<option value="">Sin selección</option>',AFNS.forEach((a=>{const t=document.createElement("option");t.value=a.ID_AFN,t.textContent=a.ID_AFN,e.appendChild(t)}))}))}}function handleObtenerAFD(e){const a=e.querySelector("#form-obtener-afd"),t=a.querySelector(".modal_button.accept"),n=a.querySelector(".modal_button.cancel"),o=a.querySelector("#tabla-afns"),r=a.querySelector("#tabla-afns-alert");function l(e,t,n){if(n.textContent="",t.classList.remove("input-error"),e.checked){const e=t.value.trim();if(/^[0-9]+$/.test(e)){const o=parseInt(e);Array.from(a.querySelectorAll('input[name^="token_afn_"]')).filter((e=>e!==t&&!e.disabled)).map((e=>parseInt(e.value.trim()))).filter((e=>!isNaN(e))).includes(o)&&(t.classList.add("input-error"),n.appendChild(i("El token ya está asignado a otro AFN.")))}else t.classList.add("input-error"),n.appendChild(i("El token debe ser un número entero."))}}function c(){a.querySelectorAll('input[name="unir_afn"]').forEach((e=>{const t=e.value;l(e,a.querySelector('input[name="token_afn_'+t+'"]'),e.parentElement.parentElement.nextSibling.firstChild)}))}function i(e){const a=document.createElement("small");return a.classList.add("error-message"),a.textContent=e,a}!function(){if(o.innerHTML="",0===AFNS.length){const e=document.createElement("tr"),a=document.createElement("td");return a.setAttribute("colspan","3"),a.textContent="No hay AFNs disponibles.",e.appendChild(a),o.appendChild(e),void(t.disabled=!0)}t.disabled=!1,AFNS.forEach((e=>{const a=document.createElement("tr"),t=document.createElement("td");t.textContent=e.ID_AFN,a.appendChild(t);const n=document.createElement("td"),r=document.createElement("input");r.type="checkbox",r.name="unir_afn",r.value=e.ID_AFN,n.appendChild(r),a.appendChild(n);const c=document.createElement("td"),i=document.createElement("input");i.type="text",i.name="token_afn_"+e.ID_AFN,i.size="5",i.disabled=!0,c.appendChild(i),a.appendChild(c);const s=document.createElement("tr"),d=document.createElement("td");d.setAttribute("colspan","3"),d.classList.add("error-cell"),s.appendChild(d),o.appendChild(a),o.appendChild(s),r.addEventListener("change",(function(){i.disabled=!this.checked,l(r,i,d)})),i.addEventListener("input",(function(){l(r,i,d)}))}))}(),a.addEventListener("input",(function(){c()})),a.addEventListener("submit",(function(t){t.preventDefault(),r.textContent="",r.classList.remove("error");let n=!0,o=[];c();const l=a.querySelectorAll('input[name="unir_afn"]:checked');if(0===l.length?(n=!1,r.textContent="Debe seleccionar al menos un AFN para unir.",r.classList.add("error")):l.forEach((e=>{const t=e.value,r=a.querySelector('input[name="token_afn_'+t+'"]'),l=r.value.trim();r.classList.contains("input-error")?n=!1:o.push({afn:AFNS.find((e=>e.ID_AFN===t)),token:parseInt(l)})})),n){o.forEach((e=>{e.afn.Edos_Acept.forEach((a=>{a.Token=e.token}))}));const a=o.map((e=>e.afn)),t=AFN.UnirAFNs(a);t.convertirAFD();const n=t.generarContenidoArchivo();iniciarDescarga(n,"matriz_transicion.txt"),mostrarNotificacion("Archivo generado exitosamente.","success"),closeModal(e)}else mostrarNotificacion("Por favor, corrige los errores antes de continuar.","error")})),n.addEventListener("click",(function(){closeModal(e)}))}function mostrarNotificacion(e,a="success"){const t=document.getElementById("notification-container"),n=document.createElement("div");n.classList.add("notification",a,"scale-in-center");const o=`\n      <h2>${"success"===a?"Éxito":"Error"}</h2>\n      <p>${e}</p>\n    `;n.innerHTML=o,t.appendChild(n),setTimeout((()=>{n.classList.remove("scale-in-center"),n.classList.add("scale-out-center"),n.addEventListener("animationend",(()=>{t.removeChild(n)}))}),2500)}document.addEventListener("modalLoaded",(function(e){const a=e.detail.modal;handleModal(a),console.log("modal"+a.getAttribute("id"))}));